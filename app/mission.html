<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VHR ‚Äî Missione</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cinzel+Decorative:wght@400;700&family=EB+Garamond:ital,wght@0,400;1,400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        :root {
            --ink: #1a1209;
            --gold: #c9922a;
            --gold-lt: #e8b84b;
            --parchment: #f2e8d0;
            --mist: #8a7d65;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--ink);
            color: var(--parchment);
            font-family: 'EB Garamond', serif;
            min-height: 100vh;
            opacity: 0;
            animation: fadeIn 0.8s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
            opacity: 0.4;
        }

        /* Topbar */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(26, 18, 9, 0.97);
            border-bottom: 1px solid rgba(201, 146, 42, 0.18);
            display: flex;
            align-items: center;
            padding: 14px 40px;
            gap: 20px;
        }

        .topbar a {
            font-family: 'Cinzel', serif;
            font-size: 11px;
            letter-spacing: 0.14em;
            color: var(--mist);
            text-decoration: none;
            text-transform: uppercase;
            transition: color .2s;
        }

        .topbar a:hover {
            color: var(--gold);
        }

        .topbar-title {
            font-family: 'Cinzel', serif;
            font-size: 12px;
            letter-spacing: 0.12em;
            color: var(--gold);
            margin-left: auto;
            margin-right: auto;
        }

        /* Page */
        .page {
            position: relative;
            z-index: 1;
            max-width: 860px;
            margin: 0 auto;
            padding: 48px 40px 80px;
        }

        /* Mission header */
        .mission-hero {
            border: 1px solid rgba(201, 146, 42, 0.18);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.02);
            padding: 36px;
            margin-bottom: 36px;
            position: relative;
            overflow: hidden;
        }

        .mission-hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 80% 50%, rgba(201, 146, 42, 0.06), transparent 70%);
            pointer-events: none;
        }

        .mh-top {
            display: flex;
            align-items: flex-start;
            gap: 24px;
            margin-bottom: 20px;
        }

        .mh-element {
            font-size: 3.5em;
            flex-shrink: 0;
        }

        .mh-info {
            flex: 1;
        }

        .mh-eyebrow {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: var(--mist);
            margin-bottom: 8px;
        }

        .mh-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: clamp(1.3rem, 3vw, 2rem);
            font-weight: 700;
            color: var(--parchment);
            margin-bottom: 6px;
        }

        .mh-location {
            font-style: italic;
            color: var(--mist);
            font-size: 0.95em;
        }

        .mh-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .badge-pill {
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid;
        }

        .badge-pill.diff-facile {
            color: #6dbf67;
            border-color: rgba(109, 191, 103, 0.35);
            background: rgba(109, 191, 103, 0.08);
        }

        .badge-pill.diff-media {
            color: var(--gold-lt);
            border-color: rgba(232, 184, 75, 0.35);
            background: rgba(232, 184, 75, 0.08);
        }

        .badge-pill.diff-difficile {
            color: #ff8c6b;
            border-color: rgba(255, 140, 107, 0.35);
            background: rgba(255, 140, 107, 0.08);
        }

        .badge-pill.diff-mitica {
            color: #d4a0ff;
            border-color: rgba(212, 160, 255, 0.35);
            background: rgba(212, 160, 255, 0.08);
        }

        .badge-pill.gold {
            color: var(--gold);
            border-color: rgba(201, 146, 42, 0.35);
            background: rgba(201, 146, 42, 0.08);
        }

        .mh-desc {
            font-style: italic;
            color: rgba(242, 232, 208, 0.72);
            line-height: 1.9;
            font-size: 1.05em;
        }

        /* Purchase CTA */
        .purchase-box {
            background: rgba(201, 146, 42, 0.06);
            border: 1px solid rgba(201, 146, 42, 0.25);
            border-radius: 4px;
            padding: 24px 28px;
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .purchase-text {
            font-style: italic;
            color: var(--mist);
            font-size: 0.95em;
            max-width: 340px;
        }

        .purchase-price {
            font-family: 'Cinzel Decorative', serif;
            font-size: 1.8em;
            color: var(--gold-lt);
        }

        .btn-purchase {
            font-family: 'Cinzel', serif;
            font-size: 12px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: var(--ink);
            background: linear-gradient(135deg, var(--gold-lt), var(--gold));
            padding: 12px 32px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            transition: all .3s;
            box-shadow: 0 0 20px rgba(201, 146, 42, 0.2);
        }

        .btn-purchase:hover {
            box-shadow: 0 0 40px rgba(201, 146, 42, 0.4);
            transform: translateY(-1px);
        }

        .btn-free {
            background: rgba(109, 191, 103, 0.15);
            border: 1px solid rgba(109, 191, 103, 0.4);
            color: #6dbf67;
        }

        .btn-free:hover {
            background: rgba(109, 191, 103, 0.25);
        }

        /* Stops */
        .stops-title {
            font-family: 'Cinzel', serif;
            font-size: 0.95em;
            letter-spacing: 0.08em;
            color: var(--parchment);
            border-bottom: 1px solid rgba(201, 146, 42, 0.15);
            padding-bottom: 10px;
            margin-bottom: 24px;
        }

        .stops-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stop-card {
            border: 1px solid rgba(201, 146, 42, 0.12);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.02);
            padding: 22px 20px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
            transition: border-color .3s;
        }

        .stop-card.active {
            border-color: rgba(201, 146, 42, 0.35);
            background: rgba(201, 146, 42, 0.04);
        }

        .stop-card.done {
            border-color: rgba(109, 191, 103, 0.25);
            background: rgba(109, 191, 103, 0.03);
        }

        .stop-card.locked {
            opacity: 0.45;
        }

        .stop-num {
            width: 36px;
            height: 36px;
            flex-shrink: 0;
            border-radius: 50%;
            border: 1px solid rgba(201, 146, 42, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel', serif;
            font-size: 11px;
            color: var(--gold);
        }

        .stop-card.done .stop-num {
            background: rgba(109, 191, 103, 0.15);
            border-color: rgba(109, 191, 103, 0.4);
            color: #6dbf67;
        }

        /* Toast message */
        #toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(180, 30, 30, 0.9);
            color: #ff8a8a;
            padding: 12px 24px;
            border: 1px solid rgba(180, 30, 30, 0.4);
            border-radius: 4px;
            font-family: 'Cinzel', serif;
            font-size: 11px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            pointer-events: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .shake {
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .stop-body {
            flex: 1;
        }

        .stop-name {
            font-family: 'Cinzel', serif;
            font-size: 0.95em;
            color: var(--parchment);
            margin-bottom: 4px;
        }

        .stop-location {
            font-style: italic;
            color: var(--mist);
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .stop-hint {
            font-size: 0.85em;
            color: rgba(242, 232, 208, 0.55);
            font-style: italic;
        }

        .btn-start-stop {
            font-family: 'Cinzel', serif;
            font-size: 11px;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--ink);
            background: var(--gold);
            padding: 9px 24px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            transition: all .2s;
            text-decoration: none;
            display: inline-block;
            margin-top: 12px;
        }

        .btn-start-stop:hover {
            background: var(--gold-lt);
        }

        .done-badge {
            display: inline-block;
            font-family: 'Cinzel', serif;
            font-size: 9px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-top: 10px;
            color: #6dbf67;
            border: 1px solid rgba(109, 191, 103, 0.35);
            padding: 4px 12px;
            border-radius: 20px;
        }

        @media(max-width:600px) {
            .page {
                padding: 24px 16px 60px;
            }

            .mh-top {
                flex-direction: column;
                gap: 12px;
            }

            .purchase-box {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Leaflet Map Styles */
        #mission-map {
            height: 350px;
            width: 100%;
            border: 1px solid rgba(201, 146, 42, 0.25);
            border-radius: 4px;
            margin-bottom: 30px;
            z-index: 10;
            position: relative;
        }

        .leaflet-layer,
        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out,
        .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: rgba(26, 18, 9, 0.95);
            color: var(--parchment);
            border: 1px solid rgba(201, 146, 42, 0.4);
            font-family: 'EB Garamond', serif;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 4px;
        }

        .leaflet-popup-content {
            margin: 12px;
        }

        .leaflet-popup-content h3 {
            font-family: 'Cinzel', serif;
            font-size: 13px;
            color: var(--gold);
            margin-bottom: 4px;
        }

        .leaflet-popup-content p {
            font-size: 12px;
            margin: 0;
            color: var(--mist);
        }
    </style>
</head>

<body>

    <header class="topbar">
        <a href="dashboard-player.html" class="ar-back">‚Üê Dashboard</a>
        <span class="topbar-title" id="topbar-title">Missione</span>
    </header>

    <div class="page">
        <div id="mission-content"><!-- JS --></div>
    </div>

    <div id="toast">Risolvi la tappa precedente per sbloccare</div>

    <script type="module">
        import { auth, db } from '../firebase/firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        import { collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const params = new URLSearchParams(location.search);
        let missionId = params.get('id') || 'm1';
        let mission = null;

        let currentUser = null;
        let userData = {};

        async function fetchMissionData(mId) {
            try {
                const mSnap = await getDoc(doc(db, 'missions', mId));
                if (mSnap.exists()) {
                    mission = mSnap.data();
                    mission.id = mId;
                    const stopsSnap = await getDocs(query(collection(db, 'missions', mId, 'stops'), orderBy('order')));
                    mission.stops = stopsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                } else {
                    console.error("Mission not found in DB");
                }
            } catch (e) {
                console.error("Error fetching mission", e);
            }
        }

        async function init(user, data) {
            currentUser = user; userData = data;

            // Allow override for easier local testing
            if (params.get('mock') === 'true') {
                missionId = 'm1'; // Try to load first mission
                const backupMissions = await getDocs(collection(db, 'missions'));
                if (!backupMissions.empty) {
                    missionId = backupMissions.docs[0].id;
                }
            }

            await fetchMissionData(missionId);

            if (!mission) {
                document.getElementById('mission-content').innerHTML = '<p style="color:var(--mist);padding:40px 0;font-style:italic">Nessuna missione trovata. Verificare il Database.</p>';
                return;
            }
            renderMission();
        }

        // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderMission() {
            document.title = `VHR ‚Äî ${mission.title || mission.name || 'Missione'}`;
            document.getElementById('topbar-title').textContent = mission.title || mission.name || 'Missione';

            const active = userData.activeMissions || [];
            const unlocked = mission.isFree || active.includes(missionId);
            const completedSt = userData.completedStops || {};
            const mDone = completedSt[missionId] || [];

            const diffNames = ['Molto Facile', 'Facile', 'Media', 'Difficile', 'Mitica'];
            const diffName = diffNames[(mission.difficulty || 1) - 1] || 'Media';
            const diffClass = 'diff-' + diffName.toLowerCase();

            const purchaseBlock = (!mission.isFree && !unlocked) ? `
      <div class="purchase-box">
        <div>
          <div class="purchase-price">‚Ç¨ ${(mission.price || 0).toFixed(2)}</div>
          <div class="purchase-text">Sblocca questa missione per iniziare l'avventura ed accedere a tutte le tappe AR.</div>
        </div>
        <button class="btn-purchase" onclick="mockPurchase()">‚ú¶ Sblocca Missione</button>
      </div>` : '';

            const stopsHTML = (mission.stops || []).map((s, i) => {
                const prevDone = i === 0 || mDone.includes(mission.stops[i - 1].id);
                const isDone = mDone.includes(s.id);
                const isActive = (mission.isFree || unlocked) && !isDone && prevDone;
                const isLocked = !isDone && !isActive;
                const cardClass = isDone ? 'done' : isActive ? 'active' : 'locked';
                const action = isActive
                    ? `<a href="ar-scanner.html?mission=${missionId}&stop=${s.id}&rune=${encodeURIComponent(s.rune || '·ö¢')}" class="btn-start-stop">üì± Avvia Tappa AR</a>`
                    : isDone
                        ? `<span class="done-badge">‚úì Completata</span>`
                        : '';
                const clickHandler = isLocked ? `onclick="showLockedMessage(this)" style="cursor:pointer;"` : '';
                return `
        <div class="stop-card ${cardClass}" ${clickHandler}>
          <div class="stop-num">${isDone ? '‚úì' : i + 1}</div>
          <div class="stop-body">
            <div class="stop-name">${s.name || 'Tappa Sconosciuta'}</div>
            <div class="stop-location">üìç ${s.name}</div>
            ${isActive ? `<div class="stop-hint">Cerca il marker: <strong>${s.rune || '·ö¢'}</strong> ‚Äî punta la fotocamera sulla runa stampata</div>` : ''}
            ${action}
          </div>
        </div>`;
            }).join('');

            const totalXp = (mission.stops || []).reduce((acc, curr) => acc + (curr.xp || 100), 0);

            document.getElementById('mission-content').innerHTML = `
      <div class="mission-hero">
        <div class="mh-top">
          <div class="mh-element">‚ö°</div>
          <div class="mh-info">
            <div class="mh-eyebrow">Missione ¬∑ Difficolt√† ${mission.difficulty || 1}/5 ¬∑ ${(mission.stops || []).length} Tappe</div>
            <h1 class="mh-title">${mission.title || mission.name}</h1>
            <div class="mh-location">üìç Vercelli</div>
            <div class="mh-badges">
              <span class="badge-pill ${diffClass}">${diffName}</span>
              <span class="badge-pill gold">‚ö° ${totalXp} XP</span>
              ${mission.isFree ? '<span class="badge-pill" style="color:#6dbf67;border-color:rgba(109,191,103,0.35)">Gratuita</span>' : ''}
            </div>
          </div>
        </div>
        <p class="mh-desc">${mission.description || mission.shortDesc || mission.desc || ''}</p>
      </div>

                ${purchaseBlock}

      <div class="stops-title">Mappa Tappe</div>
      <div id="mission-map"></div>

      <div class="stops-title">Diario di Missione</div>
      <div class="stops-list">${stopsHTML}</div>
    `;

            // Initialize Map
            setTimeout(() => {
                if (window.missionMap) { window.missionMap.remove(); }

                const hasStops = mission.stops && mission.stops.length > 0;
                let centerLat = 45.3216;
                let centerLng = 8.4231;

                if (hasStops && mission.stops[0].lat && mission.stops[0].lng) {
                    centerLat = mission.stops[0].lat;
                    centerLng = mission.stops[0].lng;
                }

                const map = L.map('mission-map').setView([centerLat, centerLng], 15);
                window.missionMap = map;

                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);

                const goldIcon = L.divIcon({
                    className: 'custom-pin',
                    html: '<div style="background:var(--gold);width:14px;height:14px;border-radius:50%;border:2px solid var(--ink);box-shadow:0 0 10px var(--gold);"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7],
                    popupAnchor: [0, -10]
                });

                const doneIcon = L.divIcon({
                    className: 'custom-pin-done',
                    html: '<div style="background:#6dbf67;width:14px;height:14px;border-radius:50%;border:2px solid var(--ink);box-shadow:0 0 10px #6dbf67;"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7],
                    popupAnchor: [0, -10]
                });

                if (hasStops) {
                    mission.stops.forEach((s, i) => {
                        const isDone = mDone.includes(s.id);
                        const icon = isDone ? doneIcon : goldIcon;
                        if (s.lat && s.lng) {
                            L.marker([s.lat, s.lng], { icon: icon }).addTo(map)
                                .bindPopup('<h3>' + (i + 1) + '. ' + (s.name || 'Tappa') + '</h3><p>Vercelli</p>');
                        }
                    });
                }

                // Fix map container size after a tiny layout delay
                setTimeout(() => map.invalidateSize(), 500);
            }, 300);
        }

        // ‚îÄ‚îÄ MOCK PURCHASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.mockPurchase = async () => {
            if (!currentUser) return;
            // Simulazione pagamento (mock)
            const btn = document.querySelector('.btn-purchase');
            btn.textContent = '‚è≥ Elaborazione...'; btn.disabled = true;
            await new Promise(r => setTimeout(r, 1400)); // Simula latenza

            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    activeMissions: arrayUnion(missionId)
                });
                userData.activeMissions = [...(userData.activeMissions || []), missionId];
                renderMission();
            } catch (e) {
                // Offline fallback
                userData.activeMissions = [...(userData.activeMissions || []), missionId];
                renderMission();
            }
        };

        window.showLockedMessage = (el) => {
            el.classList.remove('shake');
            void el.offsetWidth; // trigger reflow
            el.classList.add('shake');
            const toast = document.getElementById('toast');
            if (toast) {
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            }
        };

        // ‚îÄ‚îÄ LOAD START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        onAuthStateChanged(auth, async user => {
            if (params.get('mock') === 'true') {
                init({ uid: 'mock', displayName: 'Mock User' }, { activeMissions: ['m1'], completedStops: { 'm1': ['s1'] } });
                return;
            }
            if (!user) { window.location.href = 'login.html'; return; }
            const snap = await getDoc(doc(db, 'users', user.uid));
            init(user, snap.exists() ? snap.data() : {});
        });
    </script>
</body>

</html>